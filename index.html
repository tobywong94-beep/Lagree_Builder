<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"/>
  <title>Lagree Routine Builder</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lagree Builder">
  <link rel="apple-touch-icon" href="apple-touch-icon-180.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0d10">

  <style>
    :root {
      --bg: #0b0d10;
      --panel: #12161c;
      --muted: #9aa4b2;
      --text: #e6edf3;
      --brand: #7aa2ff;
      --accent: #9ef0a5;
      --danger: #ff7a7a;
      --border: #1f2630;
      --chip: #1a2230;
      --chip-text: #c8d1dc;
      --touch: 44px; /* min iOS recommended */
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-top: env(safe-area-inset-top);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      color: var(--text);
      background: linear-gradient(180deg, #0b0d10, #0f141a);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
    }
    .app {
      display: grid;
      grid-template-columns: 1fr;
      min-height: 100vh;
    }
    .sidebar {
      position: sticky; top: 0;
      z-index: 2;
      border-bottom: 1px solid var(--border);
      background: rgba(18,22,28,0.9);
      backdrop-filter: blur(6px);
      padding: 12px;
    }
    .content { padding: 12px; padding-bottom: calc(12px + var(--safe-bottom)); }
    h1 { font-size: 18px; font-weight: 700; margin: 0 0 4px 0; letter-spacing: 0.2px; }
    .muted { color: var(--muted); font-size: 12px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      min-height: var(--touch);
      background: var(--brand); color: #081120; border: none; border-radius: 10px;
      padding: 10px 12px; font-weight: 800; cursor: pointer;
      transition: transform .04s ease, opacity .2s ease; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.secondary { background: #1b2534; color: var(--text); border: 1px solid var(--border); }
    .btn.ghost { background: transparent; color: var(--text); border: 1px dashed var(--border); }
    .btn.danger { background: var(--danger); color: #1a0e0e; }
    .btn:active { transform: translateY(1px); }
    .btn.small { min-height: 36px; padding: 6px 10px; font-weight: 700; }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .stack { display: grid; gap: 10px; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      padding: 14px 12px;
      background: #0f1319;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      outline: none;
      min-height: var(--touch);
    }
    input[type="text"]::placeholder, textarea::placeholder { color: #6f7a86; }
    textarea { min-height: 72px; resize: vertical; }
    .searchbox { position: relative; }
    .searchbox input { padding-left: 34px; }
    .searchbox .icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #6f7a86; font-size: 14px; }
    .list { display: grid; gap: 8px; margin-top: 10px; }
    .card {
      background: #0e141b; border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: grid; gap: 6px;
    }
    .card .title { font-weight: 800; font-size: 16px; }
    .chip { display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px; background: var(--chip); color: var(--chip-text); font-size: 12px; gap: 6px; border: 1px solid var(--border); }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .section-title { font-size: 13px; font-weight: 900; letter-spacing: .3px; margin: 12px 0 6px }
    .divider { height: 1px; background: var(--border); margin: 8px 0; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 1; padding: 6px 0; }
    .right { margin-left: auto; }
    .block { border: 1px dashed var(--border); border-radius: 12px; padding: 10px; background: rgba(10,14,20,0.5); display: grid; gap: 8px; }
    .block-header { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; }
    .table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .table th, .table td { border-bottom: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: middle; }
    .table th { font-size: 12px; color: var(--muted); font-weight: 800; }
    .table input[type="text"] { padding: 10px 10px; min-height: 40px; }
    .small-muted { color: var(--muted); font-size: 12px; }
    .totals { display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { background: #0d1826; border: 1px solid var(--border); padding: 10px 12px; border-radius: 999px; font-weight: 800; }
    .install-banner {
      display: none; position: fixed; left: 0; right: 0; bottom: 0; z-index: 10;
      padding: 12px calc(12px + var(--safe-bottom));
      background: rgba(10,14,20,.96); border-top: 1px solid var(--border);
      color: var(--text);
    }
    .install-banner.show { display: block; }
    .ios-tip { font-size: 14px; }
    @media (min-width: 900px) {
      .app { grid-template-columns: 320px 1fr; }
      .sidebar { position: sticky; top: 0; height: 100vh; border-right: 1px solid var(--border); border-bottom: 0; }
      .toolbar { position: static; }
      .content { padding: 20px; }
    }
    @media print {
      .sidebar, .toolbar, .install-banner, .btn { display: none !important; }
      body { background: white; color: black; }
      .content { padding: 0; }
      .panel, .block { border: none; }
      .table th, .table td { border-bottom: 1px solid #ccc; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <h1>Lagree Library</h1>
      <div class="muted">Build, time, and print your routines. Autosaves offline.</div>
      <div class="section-title">Search</div>
      <div class="searchbox">
        <span class="icon">🔎</span>
        <input id="search" type="text" placeholder="Search title, tag, note…" />
      </div>
      <div class="section-title">Filters</div>
      <div class="row">
        <select id="filterCategory" aria-label="Filter by category">
          <option value="">All</option>
          <option>Signature</option>
          <option>Advanced</option>
          <option>Flex</option>
          <option>Beginner</option>
        </select>
        <select id="sortOrder" aria-label="Sort">
          <option value="updated">Recently updated</option>
          <option value="created">Recently created</option>
          <option value="title">Title A→Z</option>
        </select>
      </div>
      <div class="section-title">Actions</div>
      <div class="row">
        <button class="btn" id="newRoutineBtn">＋ New</button>
        <button class="btn secondary" id="exportBtn">Export</button>
        <label class="btn ghost" for="importInput">Import</label>
        <input id="importInput" type="file" accept="application/json" style="display:none"/>
      </div>
      <div class="divider"></div>
      <div class="list" id="routineList"></div>
    </aside>

    <main class="content">
      <div class="toolbar">
        <div id="crumbs" class="small-muted">No routine selected</div>
        <div class="right row">
          <button class="btn secondary" id="duplicateBtn" disabled>Duplicate</button>
          <button class="btn danger" id="deleteBtn" disabled>Delete</button>
          <button class="btn" id="printBtn" disabled>Print</button>
        </div>
      </div>

      <div id="editor" class="panel" style="display:none">
        <div class="stack">
          <div class="row">
            <div style="flex:1">
              <div class="small-muted">Title</div>
              <input id="titleInput" type="text" placeholder="e.g., 40-min Signature: LL → LO → RL → RO → Arms → Core"/>
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <div class="small-muted">Category</div>
              <select id="categoryInput">
                <option>Signature</option>
                <option>Advanced</option>
                <option>Flex</option>
                <option>Beginner</option>
              </select>
            </div>
            <div style="flex:1">
              <div class="small-muted">Tags (comma-separated)</div>
              <input id="tagsInput" type="text" placeholder="e.g., morning, glutes, knee-friendly"/>
            </div>
          </div>
        </div>

        <div class="section-title">Blocks</div>
        <div id="blocksContainer" class="stack"></div>

        <div class="section-title">Totals</div>
        <div class="totals">
          <span class="pill">Routine: <span id="totalTime">00:00</span></span>
          <span class="pill">Moves: <span id="totalMoves">0</span></span>
          <span class="pill">Blocks: <span id="totalBlocks">0</span></span>
        </div>
      </div>

      <div id="emptyState" class="panel">
        <b>Create a routine to get started.</b>
        <div class="muted">Pick the category and number of blocks, then add timed moves. We’ll add up totals automatically.</div>
        <div style="height:8px"></div>
        <button class="btn" id="emptyNewBtn">＋ New routine</button>
      </div>
    </main>
  </div>

  <!-- iOS Add to Home Screen banner -->
  <div id="installBanner" class="install-banner">
    <div class="row" style="align-items:flex-start; gap:12px">
      <div style="flex:1">
        <div style="font-weight:800">Install “Lagree Builder”</div>
        <div class="ios-tip">On iPhone: tap <span class="kbd">Share</span> → <b>Add to Home Screen</b> to use full‑screen & offline.</div>
      </div>
      <button class="btn small secondary" id="dismissInstall">Dismiss</button>
    </div>
  </div>

  <!-- New Routine Modal -->
  <div id="newModal" class="install-banner" style="position:fixed; top:auto; padding-bottom: calc(12px + var(--safe-bottom));">
    <div class="panel" style="max-width:700px; margin: 0 auto;">
      <h2 style="margin:0 0 8px 0">New Routine</h2>
      <div class="muted">Choose your routine type, how many blocks, and (optionally) block names.</div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="small-muted">Category</div>
          <select id="newCategory">
            <option>Signature</option>
            <option>Advanced</option>
            <option>Flex</option>
            <option>Beginner</option>
          </select>
        </div>
        <div style="width:150px">
          <div class="small-muted"># Blocks</div>
          <input id="newBlockCount" type="number" min="1" max="12" value="6" inputmode="numeric"/>
        </div>
      </div>
      <div class="section-title">Block Names</div>
      <div id="newBlockNames" class="stack"></div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn secondary" id="cancelNew">Cancel</button>
        <button class="btn" id="createNew">Create</button>
      </div>
    </div>
  </div>

  <script>
    // ----- PWA install & iOS banner -----
    (function() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(()=>{});
      }
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const banner = document.getElementById('installBanner');
      const dismissed = localStorage.getItem('lagree.pwa.dismissed') === '1';
      if (isIOS && !isStandalone && !dismissed) {
        banner.classList.add('show');
      }
      document.getElementById('dismissInstall').addEventListener('click', () => {
        banner.classList.remove('show');
        localStorage.setItem('lagree.pwa.dismissed','1');
      });
    })();
  </script>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2,10);
    const now = () => new Date().toISOString();

    function parseTimeInput(val) {
      if (!val) return 0;
      val = String(val).trim();
      if (/^\d+$/.test(val)) return parseInt(val, 10);
      const parts = val.split(':');
      if (parts.length === 2) {
        const m = parseInt(parts[0], 10) || 0;
        const s = parseInt(parts[1], 10) || 0;
        return m*60 + s;
      }
      const n = parseInt(val, 10);
      return isNaN(n) ? 0 : n;
    }
    function fmt(sec) {
      sec = Math.max(0, Math.floor(sec || 0));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    // ---------- Storage ----------
    const KEY = 'lagree.routines.v1';
    function loadAll() { try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch { return []; } }
    function saveAll(list) { localStorage.setItem(KEY, JSON.stringify(list)); }

    let routines = loadAll();
    let currentId = null;

    // ---------- Sidebar list ----------
    function renderList() {
      const q = $('#search').value.trim().toLowerCase();
      const cat = $('#filterCategory').value;
      const sort = $('#sortOrder').value;
      let items = [...routines];
      if (q) {
        items = items.filter(r => {
          const hay = [r.title, r.category, (r.tags||[]).join(','), JSON.stringify(r.blocks), r.notes||''].join(' ').toLowerCase();
          return hay.includes(q);
        });
      }
      if (cat) items = items.filter(r => r.category === cat);

      items.sort((a,b) => {
        if (sort === 'updated') return (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt);
        if (sort === 'created') return b.createdAt.localeCompare(a.createdAt);
        if (sort === 'title') return (a.title||'').localeCompare(b.title||'');
        return 0;
      });

      const root = $('#routineList');
      root.innerHTML = '';
      if (!items.length) {
        root.innerHTML = '<div class="muted">No routines found.</div>';
        return;
      }
      for (const r of items) {
        const total = totalTime(r);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="title">${escapeHtml(r.title||'(untitled)')}</div>
            <span class="chip">${escapeHtml(r.category||'')}</span>
          </div>
          <div class="chips">
            <span class="chip">⏱ ${fmt(total)}</span>
            <span class="chip">🧱 ${r.blocks?.length||0} blocks</span>
            <span class="chip">🏷 ${(r.tags||[]).slice(0,3).join(', ')}</span>
          </div>
          <div class="small-muted">Updated ${new Date(r.updatedAt||r.createdAt).toLocaleString()}</div>
        `;
        card.addEventListener('click', () => openRoutine(r.id));
        root.appendChild(card);
      }
    }
    function escapeHtml(str){return String(str||'').replace(/[&<>\"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'}[s]));}

    // ---------- Routine aggregate ----------
    function totalTime(r){ return (r.blocks||[]).reduce((acc,b)=> acc + (b.moves||[]).reduce((a,m)=> a + (m.seconds||0), 0), 0); }
    function totalMovesCount(r){ return (r.blocks||[]).reduce((acc,b)=> acc + (b.moves?.length||0), 0); }

    // ---------- Editor ----------
    function openRoutine(id) {
      currentId = id;
      const r = routines.find(x => x.id === id);
      if (!r) return;
      $('#emptyState').style.display = 'none';
      $('#editor').style.display = 'block';
      $('#crumbs').textContent = r.title ? `${r.title} • ${r.category}` : `(untitled) • ${r.category}`;
      $('#duplicateBtn').disabled = false;
      $('#deleteBtn').disabled = false;
      $('#printBtn').disabled = false;

      $('#titleInput').value = r.title || '';
      $('#categoryInput').value = r.category || 'Signature';
      $('#tagsInput').value = (r.tags||[]).join(', ');

      renderBlocks(r);
      updateTotals(r);
      renderList();
    }

    function renderBlocks(r) {
      const root = $('#blocksContainer');
      root.innerHTML = '';
      (r.blocks||[]).forEach((b, idx) => {
        const blockEl = document.createElement('div');
        blockEl.className = 'block';
        blockEl.innerHTML = `
          <div class="block-header">
            <input data-block="name" data-bid="${b.id}" type="text" value="${escapeHtml(b.name||`Block ${idx+1}`)}" />
            <span class="chip">⏱ <span data-block-total="${b.id}">${fmt(blockTotal(b))}</span></span>
            <div class="row" style="justify-content:flex-end">
              <button class="btn small secondary" data-add-move="${b.id}">＋ Move</button>
              <button class="btn small ghost" data-del-block="${b.id}">Remove</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:32%">Move</th>
                  <th style="width:18%">Time (MM:SS)</th>
                  <th style="width:20%">Variations</th>
                  <th style="width:20%">Modifications</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbody-${b.id}"></tbody>
            </table>
          </div>
        `;
        root.appendChild(blockEl);
        const tb = blockEl.querySelector('#tbody-'+b.id);
        (b.moves||[]).forEach(m => tb.appendChild(renderMoveRow(r, b, m)));
      });

      root.querySelectorAll('input[data-block="name"]').forEach(inp => {
        inp.addEventListener('input', e => {
          const bid = e.target.getAttribute('data-bid');
          const blk = r.blocks.find(x => x.id === bid);
          if (blk) { blk.name = e.target.value; touch(r); persist(); }
        });
      });
      root.querySelectorAll('button[data-add-move]').forEach(btn => {
        btn.addEventListener('click', e => {
          const bid = e.target.getAttribute('data-add-move');
          const blk = r.blocks.find(x => x.id === bid);
          if (!blk.moves) blk.moves = [];
          blk.moves.push({ id: uid(), name: '', seconds: 0, variations:'', modifications:'', notes:'' });
          touch(r); persist();
          renderBlocks(r); updateTotals(r);
        });
      });
      root.querySelectorAll('button[data-del-block]').forEach(btn => {
        btn.addEventListener('click', e => {
          const bid = e.target.getAttribute('data-del-block');
          r.blocks = r.blocks.filter(x => x.id !== bid);
          touch(r); persist();
          renderBlocks(r); updateTotals(r);
        });
      });
    }

    function renderMoveRow(r, b, m) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input data-move="name" data-mid="${m.id}" type="text" placeholder="e.g., Wheelbarrow to Bear" value="${escapeHtml(m.name||'')}"/></td>
        <td><input data-move="time" data-mid="${m.id}" type="text" inputmode="numeric" placeholder="MM:SS or SS" value="${m.seconds?fmt(m.seconds):''}"/></td>
        <td><input data-move="variations" data-mid="${m.id}" type="text" placeholder="comma-separated" value="${escapeHtml(m.variations||'')}"/></td>
        <td><input data-move="modifications" data-mid="${m.id}" type="text" placeholder="comma-separated" value="${escapeHtml(m.modifications||'')}"/></td>
        <td class="right">
          <button class="btn small ghost" data-del-move="${m.id}">✕</button>
        </td>
      `;
      tr.querySelectorAll('input[data-move]').forEach(inp => {
        inp.addEventListener('input', e => {
          const mid = e.target.getAttribute('data-mid');
          const field = e.target.getAttribute('data-move');
          const mv = (b.moves||[]).find(x => x.id === mid);
          if (mv) {
            if (field === 'time') {
              mv.seconds = parseTimeInput(e.target.value);
              document.querySelector(`[data-block-total="${b.id}"]`).textContent = fmt(blockTotal(b));
              updateTotals(r);
            } else {
              mv[field] = e.target.value;
            }
            touch(r); persist();
          }
        });
      });
      tr.querySelector('button[data-del-move]').addEventListener('click', () => {
        b.moves = (b.moves||[]).filter(x => x.id !== m.id);
        touch(r); persist();
        const tbody = $('#tbody-'+b.id);
        tbody.innerHTML = '';
        (b.moves||[]).forEach(m2 => tbody.appendChild(renderMoveRow(r,b,m2)));
        document.querySelector(`[data-block-total="${b.id}"]`).textContent = fmt(blockTotal(b));
        updateTotals(r);
      });
      return tr;
    }

    function blockTotal(b){ return (b.moves||[]).reduce((acc,m)=> acc + (m.seconds||0), 0); }
    function updateTotals(r){
      $('#totalTime').textContent = fmt(totalTime(r));
      $('#totalMoves').textContent = totalMovesCount(r);
      $('#totalBlocks').textContent = r.blocks?.length || 0;
      $('#crumbs').textContent = r.title ? `${r.title} • ${r.category} • ⏱ ${fmt(totalTime(r))}` : `(untitled) • ${r.category} • ⏱ ${fmt(totalTime(r))}`;
    }
    function persist(){ saveAll(routines); renderList(); }
    function touch(r){ r.updatedAt = now(); }

    // ---------- New routine modal (mobile-friendly) ----------
    function openNewModal() {
      const modal = document.getElementById('newModal');
      document.getElementById('newCategory').value = 'Signature';
      document.getElementById('newBlockCount').value = 6;
      renderNewBlockNameInputs(6);
      modal.classList.add('show');
    }
    function closeNewModal() { document.getElementById('newModal').classList.remove('show'); }
    function renderNewBlockNameInputs(n) {
      const container = document.getElementById('newBlockNames');
      container.innerHTML = '';
      const defaults = ['Left Leg','Left Oblique','Right Leg','Right Oblique','Arms','Core'];
      for (let i=0;i<n;i++) {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.placeholder = `Block ${i+1} name`;
        inp.value = defaults[i] || `Block ${i+1}`;
        inp.setAttribute('data-new-block-name', i);
        container.appendChild(inp);
      }
    }

    // Toolbar actions
    document.getElementById('newRoutineBtn').addEventListener('click', openNewModal);
    document.getElementById('emptyNewBtn').addEventListener('click', openNewModal);
    document.getElementById('cancelNew').addEventListener('click', closeNewModal);
    document.getElementById('newBlockCount').addEventListener('input', e => {
      let n = parseInt(e.target.value||'1', 10);
      n = Math.max(1, Math.min(12, n));
      renderNewBlockNameInputs(n);
    });
    document.getElementById('createNew').addEventListener('click', () => {
      const cat = document.getElementById('newCategory').value;
      const nameInputs = Array.from(document.querySelectorAll('input[data-new-block-name]'));
      const blocks = nameInputs.map(inp => ({ id: uid(), name: inp.value.trim() || 'Block', moves: [] }));
      const r = { id: uid(), title: `${cat} routine`, category: cat, tags: [], blocks, createdAt: now(), updatedAt: now() };
      routines.unshift(r); persist(); closeNewModal(); openRoutine(r.id); document.getElementById('titleInput').focus();
    });

    document.getElementById('titleInput').addEventListener('input', e => { const r = routines.find(x => x.id === currentId); if (r) { r.title = e.target.value; touch(r); persist(); updateTotals(r); } });
    document.getElementById('categoryInput').addEventListener('change', e => { const r = routines.find(x => x.id === currentId); if (r) { r.category = e.target.value; touch(r); persist(); updateTotals(r); } });
    document.getElementById('tagsInput').addEventListener('input', e => { const r = routines.find(x => x.id === currentId); if (r) { r.tags = e.target.value.split(',').map(s=>s.trim()).filter(Boolean); touch(r); persist(); renderList(); } });

    document.getElementById('duplicateBtn').addEventListener('click', () => {
      const src = routines.find(x => x.id === currentId); if (!src) return;
      const copy = JSON.parse(JSON.stringify(src));
      copy.id = uid(); copy.title = (src.title || 'Copy') + ' (copy)'; copy.createdAt = now(); copy.updatedAt = now();
      routines.unshift(copy); persist(); openRoutine(copy.id);
    });
    document.getElementById('deleteBtn').addEventListener('click', () => {
      if (!currentId) return; if (!confirm('Delete this routine?')) return;
      routines = routines.filter(x => x.id !== currentId); saveAll(routines); currentId = null;
      document.getElementById('editor').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('crumbs').textContent = 'No routine selected';
      document.getElementById('duplicateBtn').disabled = true;
      document.getElementById('deleteBtn').disabled = true;
      document.getElementById('printBtn').disabled = true;
      renderList();
    });
    document.getElementById('printBtn').addEventListener('click', () => { window.print(); });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = JSON.stringify(routines, null, 2);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'lagree-routines.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });
    document.getElementById('importInput').addEventListener('change', e => {
      const file = e.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try { const data = JSON.parse(reader.result); if (!Array.isArray(data)) throw new Error('Invalid file');
          routines = data; persist(); renderList(); alert('Imported ✔'); } catch (err) { alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file); e.target.value = '';
    });

    // Sidebar filters
    document.getElementById('search').addEventListener('input', renderList);
    document.getElementById('filterCategory').addEventListener('change', renderList);
    document.getElementById('sortOrder').addEventListener('change', renderList);

    renderList();
    if (routines.length) {
      const latest = [...routines].sort((a,b) => (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt))[0];
      openRoutine(latest.id);
    }

    document.addEventListener('keydown', (e) => {
      if ((e.key === 'n' || e.key === 'N') && (e.ctrlKey || e.metaKey)) { e.preventDefault(); openNewModal(); }
    });
  </script>
</body>
</html>
